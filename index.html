const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const TILE = 16;
let currentMap = "hall";

/* ===== 地圖設計 ===== */
const maps = {
  hall:[
    "####################",
    "#.................>#",
    "#..######..........#",
    "#....##............#",
    "#........#####.....#",
    "#..................#",
    "####################",
    "####################",
    "####################",
    "####################"
  ],
  corridor:[
    "####################",
    "#<.................#",
    "#.......#..........#",
    "#.......#..........#",
    "#..................#",
    "#........>.........#",
    "####################",
    "####################",
    "####################",
    "####################"
  ],
  library:[
    "####################",
    "#........>.........#",
    "#..####....####....#",
    "#..................#",
    "#....####....##....#",
    "#..................#",
    "####################",
    "####################",
    "####################",
    "####################"
  ],
  garden:[
    "####################",
    "#<.................#",
    "#......##..........#",
    "#......##..........#",
    "#..................#",
    "#........>.........#",
    "####################",
    "####################",
    "####################",
    "####################"
  ],
  treasure:[
    "####################",
    "#<.................#",
    "#......####........#",
    "#......#..#........#",
    "#......####........#",
    "#..................#",
    "####################",
    "####################",
    "####################",
    "####################"
  ]
};

/* ===== 精緻像素圖 (Base64) ===== */
const spritePlayer = new Image();
spritePlayer.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPCAYAAAA71pVKAAAArElEQVQoz2NgoBbg////P4Q/79+/vzMxMTEwMDAwPD////79+9gbGzExMTEx8fHxP///x8fHx8QEBAcHBw8PDw8PDw/Pz8XFxcbGxsYGhn5+f4GBgYGBgYGBgYGBgYGJgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGJgYGBoYGBgYGBgYGBoYGBgYGAAAAP//AwAGB9p5fRCFiwAAAABJRU5ErkJggg==";

const spriteNPC = new Image();
spriteNPC.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPCAYAAAA71pVKAAAAnUlEQVQoz2NgoBbg////P4Q/79+/f2NjY2BgYGBoZGhkYGBoYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGJgYGBgYGBoYGBgYGBgYGBoYGBgYGAAAAP//AwAGB9p5fRCFiwAAAABJRU5ErkJggg==";

const spriteObjects = new Image();
spriteObjects.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPCAYAAAA71pVKAAAAlklEQVQoz2NgoBbg////P4Q/79+/fzMxMTEwMDAwPD////79+9gbGzExMTEx8fHxP///x8fHx8QEBAcHBw8PDw8PDw/Pz8XFxcbGxsYGhn5+f4GBgYGBgYGBgYGBgYGJgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGJgYGBoYGBgYGBgYGBoYGBgYGAAAAP//AwAGB9p5fRCFiwAAAABJRU5ErkJggg==";

/* ===== 玩家設定 ===== */
const player = { x:TILE*2, y:TILE*2, w:12, h:12, dir:"down", frame:0, animTimer:0, moving:false };

/* ===== NPC ===== */
const npcs=[
  {x:TILE*10, y:TILE*2, w:12,h:12,dir:"down",frame:0,msg:["你好，我是守衛"],route:[{x:10,y:2},{x:10,y:4}],routeIndex:0,routeTimer:0,room:"hall"},
  {x:TILE*5, y:TILE*3, w:12,h:12,dir:"down",frame:0,msg:["歡迎來到書房"],route:[],room:"library"},
  {x:TILE*3, y:TILE*2, w:12,h:12,dir:"down",frame:0,msg:["庭院裡的花真漂亮"],route:[],room:"garden"},
  {x:TILE*6, y:TILE*2, w:12,h:12,dir:"down",frame:0,msg:["寶庫裡藏有寶物"],route:[],room:"treasure"}
];

/* ===== 互動物件 ===== */
const items=[
  {x:TILE*5,y:TILE*2,w:12,h:12,name:"書",msg:"這是一本古老的書",room:"hall"},
  {x:TILE*6,y:TILE*3,w:12,h:12,name:"寶箱",msg:"打開了！裡面有金幣",room:"treasure"}
];

/* ===== 對話框 ===== */
const dialog = document.getElementById("dialog");

/* ===== 鍵盤 ===== */
const keys = {};
window.addEventListener("keydown", e => keys[e.key]=true);
window.addEventListener("keyup", e => keys[e.key]=false);

/* ===== 主迴圈 ===== */
function loop(){update();draw();requestAnimationFrame(loop);}

/* ===== 更新 ===== */
function update(){
  let nx=player.x, ny=player.y; player.moving=false;
  if(keys["ArrowUp"]||keys["w"]){ny-=1; player.dir="up"; player.moving=true;}
  if(keys["ArrowDown"]||keys["s"]){ny+=1; player.dir="down"; player.moving=true;}
  if(keys["ArrowLeft"]||keys["a"]){nx-=1; player.dir="left"; player.moving=true;}
  if(keys["ArrowRight"]||keys["d"]){nx+=1; player.dir="right"; player.moving=true;}
  if(!isWall(nx,ny)) {player.x=nx; player.y=ny;}
  animatePlayer(); updateNPCs(); checkExit(); checkItems();
}

function animatePlayer(){if(!player.moving){player.frame=0; return;}
  player.animTimer++; if(player.animTimer>10){player.frame=(player.frame+1)%2; player.animTimer=0;}}

function isWall(x,y){
  const map=maps[currentMap];
  const left=Math.floor(x/TILE), right=Math.floor((x+player.w-1)/TILE);
  const top=Math.floor(y/TILE), bottom=Math.floor((y+player.h-1)/TILE);
  for(let ty=top;ty<=bottom;ty++){for(let tx=left;tx<=right;tx++){if(map[ty]&&map[ty][tx]==="#")return true;}} return false;
}

function checkExit(){
  const map=maps[currentMap]; const tx=Math.floor(player.x/TILE); const ty=Math.floor(player.y/TILE);
  const tile=map[ty][tx];
  if(tile==">"){
    if(currentMap==="hall"){currentMap="corridor"; player.x=TILE*2;}
    else if(currentMap==="library"){currentMap="garden"; player.x=TILE*2;}
    else if(currentMap==="corridor"){currentMap="library"; player.x=TILE*2;}
    else if(currentMap==="garden"){currentMap="treasure"; player.x=TILE*2;}
  }
  if(tile=="<"){
    if(currentMap==="corridor"){currentMap="hall"; player.x=TILE*17;}
    else if(currentMap==="library"){currentMap="corridor"; player.x=TILE*17;}
    else if(currentMap==="garden"){currentMap="library"; player.x=TILE*17;}
    else if(currentMap==="treasure"){currentMap="garden"; player.x=TILE*17;}
  }
}

function updateNPCs(){
  npcs.forEach(npc=>{
    if(npc.room!==currentMap) return;
    if(npc.route.length>1){
      npc.routeTimer++; if(npc.routeTimer>60){npc.routeIndex=(npc.routeIndex+1)%npc.route.length; npc.x=npc.route[npc.routeIndex].x*TILE; npc.y=npc.route[npc.routeIndex].y*TILE; npc.routeTimer=0;}
    }
    if(Math.abs(player.x-npc.x)<16 && Math.abs(player.y-npc.y)<16 && keys[" "]){dialog.style.display="block"; dialog.innerText=npc.msg[0];}
  });
}

function checkItems(){
  items.forEach(item=>{
    if(item.room!==currentMap) return;
    if(Math.abs(player.x-item.x)<16 && Math.abs(player.y-item.y)<16 && keys[" "]){dialog.style.display="block"; dialog.innerText=item.msg;}
  });
}

function draw(){ctx.clearRect(0,0,canvas.width,canvas.height); drawMap(); drawItems(); drawNPCs(); drawPlayer();}

function drawMap(){
  const map=maps[currentMap];
  for(let y=0;y<map.length;y++){for(let x=0;x<map[y].length;x++){
    let tile=map[y][x];
    if(tile==="#"){ctx.fillStyle="#444"; ctx.fillRect(x*TILE,y*TILE,TILE,TILE);}
    else if(tile==">"||tile=="<"){ctx.fillStyle="#ff0"; ctx.fillRect(x*TILE,y*TILE,TILE,TILE);}
    else{ctx.fillStyle="#ccc"; ctx.fillRect(x*TILE,y*TILE,TILE,TILE);}
  }}
}

function drawItems(){items.forEach(item=>{if(item.room!==currentMap) return; ctx.drawImage(spriteObjects,0,0,16,16,item.x,item.y,TILE,TILE);});}

function drawNPCs(){npcs.forEach(npc=>{if(npc.room!==currentMap) return; ctx.drawImage(spriteNPC,0,0,16,16,npc.x,npc.y,TILE,TILE);});}

function drawPlayer(){ctx.drawImage(spritePlayer,player.frame*16,0,16,16,player.x,player.y,TILE,TILE);}

loop();
